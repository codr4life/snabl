#ifndef SNABL_TASK_HPP
#define SNABL_TASK_HPP

#include "snabl/call.hpp"
#include "snabl/op.hpp"
#include "snabl/ptr.hpp"
#include "snabl/sarray.hpp"
#include "snabl/starray.hpp"

namespace snabl {
  struct Env;

  struct Task;
  using TaskPtr = Ptr<Task>;

  struct Task {
    enum struct Status {New, Running, Yielding, Done};
    static const I64 MaxCalls = 8, MaxScopes(8), MaxSplits = 8, MaxTries = 8;
    
    Stack stack;

    TaskPtr prev, next;
    Status status;
    I64 stack_offs;
    Lib *lib;
    PC pc;

    Starray<Scope, MaxScopes> scopes;
    Starray<Call, MaxCalls> calls;
    Sarray<ops::Try *, MaxTries> tries;
    Sarray<I64, MaxSplits> splits;

    Scope &root_scope;
    
    Task(const Task &)=delete;
    const Task &operator =(const Task &)=delete;
		
    Task(Env &env, PC start_pc, Scope *parent_scope);
  };
}

#endif
